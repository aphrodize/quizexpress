<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการแบบทดสอบ (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ระบบจัดการแบบทดสอบ</h1>
            <p class="text-gray-500 mt-2">ตั้งค่าทั่วไปและจัดการวันอบรมสำหรับแบบทดสอบ</p>
        </div>
        
        <div id="loader" class="flex justify-center items-center py-16">
            <div class="loader"></div>
        </div>

        <div id="admin-content" class="hidden">
            <!-- Config Section -->
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200 mb-8">
                 <h2 class="text-2xl font-bold text-gray-700 mb-6">การตั้งค่าทั่วไป</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                         <label for="quizTitle" class="block text-sm font-bold text-gray-600 mb-1">ชื่อแบบทดสอบ (Title)</label>
                         <input type="text" id="quizTitle" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                     <div>
                         <label for="quizSubtitle" class="block text-sm font-bold text-gray-600 mb-1">คำอธิบาย (Subtitle)</label>
                         <input type="text" id="quizSubtitle" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                      <div>
                         <label for="questionCount" class="block text-sm font-bold text-gray-600 mb-1">จำนวนคำถามที่จะสุ่ม (เช่น 20)</label>
                         <input type="number" id="questionCount" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                     <div>
                         <label for="timePerQuestion" class="block text-sm font-bold text-gray-600 mb-1">เวลาต่อข้อ (วินาที)</label>
                         <input type="number" id="timePerQuestion" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                 </div>
                 <hr class="my-8 border-t border-gray-200">
                 <h3 class="text-xl font-bold text-gray-700">ข้อความหน้าสรุปผล</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div>
                         <label for="summarySubtitle" class="block text-sm font-bold text-gray-600 mb-1">คำอธิบายหน้าสรุปผล</label>
                         <input type="text" id="summarySubtitle" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                      <div>
                         <label for="feedbackLow" class="block text-sm font-bold text-gray-600 mb-1">ข้อความคะแนนน้อย (น้อยกว่า 50%)</label>
                         <input type="text" id="feedbackLow" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                      <div>
                         <label for="feedbackMid" class="block text-sm font-bold text-gray-600 mb-1">ข้อความคะแนนปานกลาง (50% - 75%)</label>
                         <input type="text" id="feedbackMid" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                      <div>
                         <label for="feedbackHigh" class="block text-sm font-bold text-gray-600 mb-1">ข้อความคะแนนสูง (มากกว่า 75%)</label>
                         <input type="text" id="feedbackHigh" class="config-input w-full p-2 border border-gray-300 rounded-md">
                     </div>
                 </div>
            </div>
            
            <!-- Training Dates Section -->
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">จัดการวันอบรม</h2>
                <div id="training-dates-list" class="space-y-3">
                    <!-- Date rows will be injected here -->
                </div>
                <button id="add-date-btn" class="mt-4 bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">
                    เพิ่มวันอบรมใหม่
                </button>
            </div>

            <div class="mt-8 flex flex-col md:flex-row gap-4">
                <button id="save-changes-btn" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition flex items-center justify-center">
                    <span id="save-btn-text">บันทึกการเปลี่ยนแปลงทั้งหมด</span>
                    <div id="save-btn-spinner" class="hidden w-5 h-5 border-2 border-white border-solid border-t-transparent rounded-full animate-spin ml-2"></div>
                </button>
                <a href="YOUR_QUIZ_FORM_URL_HERE" target="_blank" class="w-full md:w-auto text-center bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition">
                    ไปที่หน้าทำแบบทดสอบ
                </a>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx45oaqaeLQ4vCgeD10AQl8BjQ2u_JXksdpGj3crajHFqtrlw7sff5ggZG7_dYXlSJaMg/exec";
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminData();
            document.getElementById('add-date-btn').addEventListener('click', addDateRow);
            document.getElementById('save-changes-btn').addEventListener('click', saveAllChanges);
        });

        async function loadAdminData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getAdminData`);
                const result = await response.json();
                if (result.error) throw new Error(result.message);
                
                // Populate Config
                document.getElementById('quizTitle').value = result.config.quizTitle || '';
                document.getElementById('quizSubtitle').value = result.config.quizSubtitle || '';
                document.getElementById('questionCount').value = result.config.questionCount || '20';
                document.getElementById('timePerQuestion').value = result.config.timePerQuestion || '15';
                document.getElementById('summarySubtitle').value = result.config.summarySubtitle || '';
                document.getElementById('feedbackLow').value = result.config.feedbackLow || '';
                document.getElementById('feedbackMid').value = result.config.feedbackMid || '';
                document.getElementById('feedbackHigh').value = result.config.feedbackHigh || '';

                // Populate Training Dates
                renderTrainingDates(result.trainingDates || []);

            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`);
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
            }
        }

        function renderTrainingDates(dates) {
            const list = document.getElementById('training-dates-list');
            list.innerHTML = '';
            if (dates.length > 0) {
                dates.forEach(dateInfo => {
                    list.appendChild(createDateRow(dateInfo.date, dateInfo.limit));
                });
            }
        }
        
        function createDateRow(date = '', limit = '') {
            const div = document.createElement('div');
            div.className = 'date-row flex items-center gap-3';

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = date;
            dateInput.className = 'date-input p-2 border border-gray-300 rounded-md w-full';

            const limitInput = document.createElement('input');
            limitInput.type = 'number';
            limitInput.value = limit;
            limitInput.placeholder = 'จำนวนที่รับ';
            limitInput.className = 'limit-input p-2 border border-gray-300 rounded-md w-48';

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'w-9 h-9 flex items-center justify-center bg-red-100 text-red-700 rounded-full hover:bg-red-200 font-bold';
            deleteBtn.onclick = () => div.remove();

            div.appendChild(dateInput);
            div.appendChild(limitInput);
            div.appendChild(deleteBtn);
            return div;
        }

        function addDateRow() {
            document.getElementById('training-dates-list').appendChild(createDateRow());
        }

        function collectDataFromUI() {
            const updatedConfig = {
                quizTitle: document.getElementById('quizTitle').value.trim(),
                quizSubtitle: document.getElementById('quizSubtitle').value.trim(),
                questionCount: document.getElementById('questionCount').value.trim(),
                timePerQuestion: document.getElementById('timePerQuestion').value.trim(),
                summarySubtitle: document.getElementById('summarySubtitle').value.trim(),
                feedbackLow: document.getElementById('feedbackLow').value.trim(),
                feedbackMid: document.getElementById('feedbackMid').value.trim(),
                feedbackHigh: document.getElementById('feedbackHigh').value.trim(),
            };
            
            const updatedDates = [];
            document.querySelectorAll('.date-row').forEach(row => {
                const date = row.querySelector('.date-input').value;
                const limit = row.querySelector('.limit-input').value;
                if (date && limit) {
                    updatedDates.push({ date, limit });
                }
            });

            return { config: updatedConfig, trainingDates: updatedDates };
        }

        async function saveAllChanges() {
            const allData = collectDataFromUI();
            
            const saveBtn = document.getElementById('save-changes-btn');
            const btnText = document.getElementById('save-btn-text');
            const btnSpinner = document.getElementById('save-btn-spinner');

            saveBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ type: 'saveAdminData', data: allData })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.message);
                alert('บันทึกการเปลี่ยนแปลงเรียบร้อย!');
                loadAdminData();
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>

